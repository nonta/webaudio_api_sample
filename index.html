<!DOCTYPE html>
<html>
<head lang="ja">
<meta charset="UTF-8">
<title>パララックステスト</title>
<link rel="stylesheet" href="stylesheets/style.css" type="text/css">
</head>

<body data-vide-bg="">
<audio id="sound" src="se/sizen.mp3" type="audio/mp3" loop autoplay></audio><script>
var TARGET = document.getElementById('sound');
function play(){
    TARGET.play();
}
function pause(){
    TARGET.pause();
}
</script>

<div class="bg_fixed"
data-0="zoom: 10;"
data-10000="zoom: 1;"
></div>
<div class="num"><span id="scrollValue">0</span><br>
<a onclick="pause();">PAUSE</a>
</div>

<div class="img_7"
data-0= "opacity: 1; zoom: 1;  top:0%; right: 0%"
data-2400= "opacity: 0; zoom: 1; top:0%; right: 0%;"
>
<div class="headphone"><a onclick="play();" class="play">PLAY</a></div>
</div>

<div class="img_8"
data-1000= "opacity: 0; zoom: 1;  top:0%; right: 0%"
data-2000= "opacity: 1; zoom: 1;  top:0%; right: 0%"
data-4000= "opacity: 0.7; zoom: 1;  top:0%; right: 0%"
data-5000= "opacity: 0; zoom: 1;  top:0%; right: 0%"
></div>


<div id="animal_1" class="img_box img_1"
data-emit-events
data-sound="se/blueyellow.wav"
data-3000="opacity: 0; zoom: 0;  top:8%;"
data-4000="opacity: 0.99; zoom: 0.6;  top: 20%;"
data-5000="opacity: 1; zoom: 1;  top:10%; left: 10%;"
data-6000="opacity: 0; zoom: 5; top:20%; left: 100%;"
></div>

<div id="animal_2" class="img_box img_2"
data-emit-events
data-sound="se/blueyellow.wav"
data-5800="opacity: 0; zoom: 0;  top:8%; right: 20%"
data-7000="opacity: 0.99; zoom: 0.6;  top:15%;"
data-8000="opacity: 1; zoom: 1;  top:0%; right: 10%;"
data-10000="opacity: 0; zoom: 5; top:8%; right: 100%;"
></div>

<div id="animal_3" class="img_box img_3"
data-emit-events
data-sound="se/blueyellow.wav"
data-9000= "opacity: 0; zoom: 0;  top:0%; left: 50%"
data-10000="opacity: 0.99; zoom: 0.6;  top:15%; left: 50%;"
data-11000="opacity: 1; zoom: 1;  top:0%; left: 20%;"
data-13000="opacity: 0; zoom: 5; top:0%; left: 10%;"
></div>

<div id="animal_4" class="img_box img_4"
data-emit-events
data-sound="se/blueyellow.wav"
data-12000="opacity: 0; zoom: 0;  top:30%;"
data-13000="opacity: 0.99; zoom: 0.6;  top: 20%;"
data-14000="opacity: 1; zoom: 1;  top:0%; left: 10%;"
data-15000="opacity: 0; zoom: 5; top:0%; left: 100%;"
></div>

<div id="animal_5" class="img_box img_5"
data-emit-events
data-sound="se/blueyellow.wav"
data-14000="opacity: 0; zoom: 0;  top:40%; right: 50%"
data-16000="opacity: 0.99; zoom: 0.6;  top:15%; right: 50%;"
data-17000="opacity: 1; zoom: 1;  top:0%; right: 0%;"
data-18000="opacity: 0; zoom: 5; top:0%; right: 0%;"
></div>

<div id="animal_6" class="img_box img_6"
data-emit-events
data-sound="se/blueyellow.wav"
data-18000="opacity: 0; zoom: 0;  top:40%; left: 60%"
data-19000="opacity: 0.99; zoom: 0.6;  top:15%; left: 10%;"
data-20000="opacity: 1; zoom: 1;  top:6%; left: 0%;"
data-21000="opacity: 0; zoom: 5; top:20%; left: 0%;"
></div>

<div class="img_7"
data-20000= "opacity: 0; zoom: 1;  top:0%; right: 0%"
data-21000= "opacity: 1; zoom: 1;  top:0%; right: 0%"
data-22000= "opacity: 0; zoom: 1; top:0%; right: 0%;"
></div>

<div class="img_8"
data-21000= "opacity: 0; zoom: 1;  top:0%; right: 0%"
data-22000= "opacity: 0.99; zoom: 1;  top:0%; right: 0%"
data-23000= "opacity: 1; zoom: 1;  top:0%; right: 0%"
></div>

<div class="cloud_btm_1"></div>
<div class="cloud_btm_2"></div>
</body>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script type="text/javascript" src="js/skrollr.js"></script>


<script>
// sound管理
var MyAudio = (function(global){
  // web audio api
  var AudioContext = webkitAudioContext || AudioContext;

  function MyAudio(buffer){
    this.is_playing = false;
    this.buffer = buffer;
    this.gain_node = context.createGain();
    this.panner = context.createPanner();

    this.panner.panningModel = 'HRTF';
    this.panner.distanceModel = 'exponential';
    //this.panner.coneOuterAngle = 180;
    //this.panner.coneInnerAngle = 0;
  }
  var context = MyAudio.context = new AudioContext();

  // soundファイル取得
  function loadFile(url){
    return new Promise(function(resolve, reject){
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.responseType = 'arraybuffer';
      xhr.onload = function(){
        xhr.status == 200 ? resolve(xhr.response) : reject(Error(xhr.statusText));
      };
      xhr.onerror = function(){
        reject(Error('http request error ' + url));
      };
      xhr.send();
    });
  }
  // soundデータの読み込み
  MyAudio.loadBuffer = function loadBuffer(url){
    return new Promise(function(resolve, reject){
      var onError = function(){
        console.error(arguments);
        reject(Error('decode error ' + url))
      };

      loadFile(url)
        .then(function(response){
          // デコード処理
          // mp3はdecodeに失敗するのでwavのみ
          // http://stackoverflow.com/questions/10365335/decodeaudiodata-returning-a-null-error
          context.decodeAudioData(response, function(buffer){ buffer ? resolve(buffer) : onError() }, onError);
        }, onError)
      ;
    });
  };
  // この位置を中心に音を聴く
  MyAudio.setListener = function (x,y,z){
    var listener = context.listener;
    //listener.setOrientation(0,0,-1,0,1,0);
    listener.setPosition(x,y,z);
  };

  // ボリューム
  MyAudio.prototype.__defineGetter__('volume', function(){
    return this.gain_node ? this.gain_node.gain.value : 0;
  });
  MyAudio.prototype.__defineSetter__('volume', function(val){
    this.gain_node.gain.value = val;
  });

  // 音を鳴らす
  MyAudio.prototype.start = function(){
    this.source = context.createBufferSource();
    this.source.loop = true;

    this.source.buffer = this.buffer;

    // 音
    this.source.connect(this.gain_node);
    // ボリューム
    this.gain_node.connect(this.panner);
    // 位置
    this.panner.connect(context.destination);

    this.source.start(0);
    this.is_playing = true;
  };
  // 音を止める
  MyAudio.prototype.stop = function(){
    if(this.is_playing){
      this.source.stop(0);
      this.source.disconnect();
      this.is_playing = false;
    }
  };
  // 音が鳴る位置指定
  MyAudio.prototype.setPosition = function(x,y,z){
    this.panner.setPosition(x, y, z);
  };

  return MyAudio;
})(window);

// 動物管理
var SoundBox = (function(global){
  function SoundBox(element){
    this.element = element;
  }
  // soundの非同期読み込み
  SoundBox.loadAsync = function(element){
    var box = new SoundBox(element);
    return new Promise(function(resolve, reject){
      var url = box.sound_url;
      if(url){
        MyAudio.loadBuffer(box.sound_url)
          .then(function(buffer){
            box.audio = new MyAudio(buffer);
            resolve(box);
          })
        ;
      }else{
        reject(Error('not define sound url'));
      }
    });
  };
  SoundBox.prototype.__defineGetter__('sound_url', function(){
    return this.element.getAttribute('data-sound');
  });

  return SoundBox;
})(window);

/*
 * sound読み込み完了時の処理
 */
function onLoadAssets(sound_list){
  // この位置を中心に音を聴く
  // x:100 y:100 z:100をとりあえず中心にする
  MyAudio.setListener(50, 0, 100);
  // 現在表示されている動物
  var visible_boxes = [];

  // 動物divの中心を取得するためにdocumentの幅取得
  var document_width = document.body.offsetWidth;
  window.addEventListener('resize', function(){
    document_width = document.body.offsetWidth;
  });

  // 動物の位置が変わった時に音の位置を再計算
  var updatePosition = function(sound_box){
    var zoom = parseFloat(sound_box.element.style.zoom) || 0;
    var left = sound_box.element.offsetLeft * zoom;
    var center = left + sound_box.element.offsetWidth * zoom / 2;

    var position = {
      x: center / document_width
    };
    sound_box.audio.setPosition(position.x * 100, 100, zoom*100);
  };
  // スクロールイベント処理
  var onScroll = function(){
    visible_boxes.forEach(function(sound_box){
      updatePosition(sound_box);
    });
  };
  // 音を鳴らす処理
  var attachSoundEffect = function(sound_box){
    updatePosition(sound_box);
    sound_box.audio.start();
    visible_boxes.push(sound_box);
  };
  // 音を消す処理
  var detachSoundEffect = function(sound_box){
    sound_box.audio.stop();
    visible_boxes = visible_boxes.filter(function(v){
      return sound_box.element.id !== v.element.id;
    });
  };
  var attachScrollEvent = function(sound_box){
    sound_box.element.addEventListener('skrollr:classChanged', function(e){
      switch(e.detail){
      case 'skrollable-before':   // 動物表示前
      case 'skrollable-after':    // 動物が通り過ぎた後
        detachSoundEffect(sound_box);
        break;
      case 'skrollable-between':  // 動物が前に表示されている状態
        attachSoundEffect(sound_box);
        sound_box.audio.volume = 10; // ボリューム設定
        break;
      }
    });
  };

  sound_list.forEach(function(sound_box){
    attachScrollEvent(sound_box);
  });

  // skrollrでパララックス
  var s = skrollr.init({render:onScroll});
}

</script>

<script>
$(function() {
    $(window).scroll(function() {
        var value = $(this).scrollTop(); //スクロールの値を取得
        $('#scrollValue').text(value);
    });
});
</script>
<script>
$(document).ready(function(){
    var wW = $(window).width(); 
    var wH = $(window).height(); 
    var divW = $('.img_box').innerWidth();
    var divH = $('.img_box').innerHeight();
    if(wW > divW){
      $('.img_box').css('width',wW*0.8+'px'); 
    }
    if(wH > divH){
      $('.img_box').css('height',wH*0.8+'px'); 
    }
});
</script>

<script>
(function(){
  // 初期化処理で.img_boxのdata-soundを事前に読み込む
  var sound_boxes = Array.apply(null, document.getElementsByClassName('img_box'));
  Promise.all(sound_boxes.map(function(sound_box){
    return SoundBox.loadAsync(sound_box);
  })).then(onLoadAssets);
})();
</script>
</html>
